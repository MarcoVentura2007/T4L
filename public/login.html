<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T4L | Login</title>
    <link rel="icon" href="immagini/Icona.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2B2B30">
</head>

<body style="overflow: hidden;">

  <img src="immagini/top-right.png" alt="" class="top-right">
  <img src="immagini/bottom-left.png" alt="" class="bottom-left">

  <div class="three-columns">
    <div class="col">
      <img src="immagini/overlimits.png" class="col-image" style="max-width: 75%; float: right; margin-right: 17px;">
    </div>

    <div class="col">
      <img src="immagini/TIME4ALL_LOGO-removebg-preview.png" class="col-image">
    </div>

    <div class="col">
      <img src="immagini/Logo-Cooperativa-Ergaterapeutica.png" class="col-image" style="margin-bottom: 5px;">
    </div>
  </div>

  <div class="login-container">
    <form class="login-form" id="loginForm">
      <h2 id="titolo-login">LOGIN</h2>

      <div class="input-wrap">
        <input id="username" class="colored-input" type="text" autocomplete="off" name="username" placeholder="Username" required>
      </div>

      <div class="input-wrap">
        <input id="password" class="colored-input" type="password" autocomplete="off" name="password" placeholder="Password" required>
        <img draggable="false" id="eyeicon" src="immagini/view.png" style="cursor:pointer;">
      </div>

      <button class="login-button">Accedi</button>

      <div id="message" style="opacity: 0;">❌Credenziali non valide</div>
    </form>
  </div>

<script>

    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log("SW registrato:", reg))
                .catch(err => console.log("SW fallito:", err));
        });
    }

    const form = document.getElementById("loginForm");
    const messageDiv = document.getElementById("message");
    const eyeicon = document.getElementById("eyeicon");
    const passwordInput = document.getElementById("password");

    // Mostra/Nascondi password
    eyeicon.onclick = () => {
        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            eyeicon.src = "immagini/hide.png";
        } else {
            passwordInput.type = "password";
            eyeicon.src = "immagini/view.png";
        }
    };

    // LOGIN UNIFICATO
    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        try {
            const response = await fetch("/login", {
                method: "POST",
                body: new FormData(form)
            });

            const data = await response.json();

            if (data.token) {
              
                localStorage.setItem("token", data.token);
                localStorage.setItem("username", username)

              
                if (data.username) {
                    sessionStorage.setItem("username", data.username);
                }

                window.location.href = "index.html";
            } else {
                messageDiv.textContent = "❌ Credenziali errate";
                messageDiv.style.opacity = "1";
            }

        } catch (err) {
            console.error(err);
            messageDiv.textContent = "⚠ Errore di connessione";
            messageDiv.style.opacity = "1";
        }
    });

</script>

</body>
</html>
